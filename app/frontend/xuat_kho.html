<!DOCTYPE html>
<html class="light" lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Xuất Kho</title>

<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>

<link href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet">

<style>
.material-symbols-outlined {
  font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
}
.material-symbols-outlined.fill {
  font-variation-settings: 'FILL' 1;
}
  body { margin-left: 16rem; }

  iframe {
    scrollbar-width: none; /* Firefox */
  }

  iframe::-webkit-scrollbar {
    display: none; /* Chrome */
  }
</style>

<script>
tailwind.config = {
  darkMode: "class",
  theme: {
    extend: {
      colors: {
        "primary": "#1E7C4B",
        "background-light": "#f7f8fa",
        "background-dark": "#101a14",
        "surface-light": "#ffffff",
        "surface-dark": "#1a2c22",
        "text-primary-light": "#131811",
        "text-primary-dark": "#e8f5e9",
        "text-secondary-light": "#4F4F4F",
        "text-secondary-dark": "#a5d6a7",
        "border-light": "#e0e0e0",
        "border-dark": "#385443",
        "accent": "#F2994A"
      },
      fontFamily: { display: ["Work Sans", "sans-serif"] }
    }
  }
}
</script>
<script>
    // Gửi tên file đang mở vào iframe sidebar
    function sendPageName() {
        const page = window.location.pathname.split("/").pop();
        const sidebar = document.querySelector("iframe");

        if (sidebar && sidebar.contentWindow) {
            sidebar.contentWindow.postMessage({page}, "*");
        }
    }

    window.onload = sendPageName;
</script>
</head>

<body class="font-display bg-background-light dark:bg-background-dark text-text-primary-light dark:text-text-primary-dark">
<div class="flex min-h-screen">

<iframe src="sidebar.html" class="fixed left-0 top-0 w-64 h-full border-r" frameborder="0"></iframe>

<!-- ================= MAIN CONTENT ================ -->
<main class="flex-1 p-6 lg:p-8 ml-64">
<div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-8">

<!-- ================= FORM XUẤT KHO ================ -->
<div class="lg:col-span-2 flex flex-col gap-6">

    <h1 class="text-3xl font-bold">Tạo Phiếu Xuất Kho</h1>

    <div class="bg-surface-light p-6 rounded-xl border border-border-light flex flex-col gap-6">

        <!-- Thông tin chung -->
        <div>
            <h3 class="text-lg font-semibold mb-4">Thông tin chung</h3>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="text-sm">Mã phiếu</label>
                    <input id="export_code" class="form-input w-full h-12 px-3 rounded-lg bg-background-light border">
                </div>

                <div>
                    <label class="text-sm">Ngày xuất</label>
                    <input id="export_date" type="date" class="form-input w-full h-12 px-3 rounded-lg bg-background-light border">
                </div>
            </div>

            <label class="mt-3 block text-sm">Người nhận</label>
            <input id="receiver" class="form-input w-full h-12 px-3 rounded-lg bg-background-light border">
        </div>

        <!-- Chọn sản phẩm -->
        <div>
            <h3 class="text-lg font-semibold mb-3">Chọn sản phẩm xuất kho</h3>

            <div class="grid grid-cols-3 gap-4 mb-4">
                <select id="select_product" class="form-input h-12 px-2 rounded-lg bg-background-light border"></select>

                <input id="select_quantity" type="number" placeholder="Số lượng"
                       class="form-input h-12 px-3 bg-background-light border">

                <button onclick="addProductToTable()" class="h-12 bg-primary text-white px-4 rounded-lg">
                    Thêm
                </button>
            </div>
        </div>

        <!-- TABLE -->
        <div class="overflow-x-auto rounded-lg border">
            <table class="w-full text-sm">
                <thead class="bg-background-light text-xs uppercase">
                    <tr>
                        <th class="px-4 py-3">Sản phẩm</th>
                        <th class="px-4 py-3">Đơn vị</th>
                        <th class="px-4 py-3">Số lượng</th>
                        <th class="px-4 py-3">Đơn giá</th>
                        <th class="px-4 py-3 text-right">Tổng</th>
                        <th></th>
                    </tr>
                </thead>

                <tbody id="detailTable"></tbody>
            </table>
        </div>

        <!-- Tổng tiền -->
        <div class="flex flex-col gap-2 text-sm mt-4">
            <div class="flex justify-between"><span>Tổng tiền</span><span id="total_price">0 đ</span></div>

            <div class="border-t my-2"></div>

            <div class="flex justify-between text-lg font-bold">
                <span>Tổng thanh toán</span>
                <span id="final_price">0 đ</span>
            </div>
        </div>

        <button onclick="submitExport()" class="px-5 py-2.5 text-sm font-semibold rounded-lg bg-primary text-white">
            Lưu & Xác nhận
        </button>

    </div>
</div>

<!-- ================= LỊCH SỬ XUẤT KHO ================ -->
<div class="lg:col-span-1 flex flex-col gap-6">

<div class="bg-surface-light p-6 rounded-xl border">

    <h3 class="text-lg font-semibold mb-3">Lịch sử xuất kho</h3>

    <input class="form-input mb-3 pl-10 h-12 w-full rounded-lg bg-background-light border"
           placeholder="Tìm theo mã phiếu, người nhận...">

    <div id="historyBox" class="flex flex-col gap-4 max-h-[600px] overflow-y-auto"></div>

    <!-- POPUP -->
    <div id="exportDetailModal"
         class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
        <div class="bg-white dark:bg-surface-dark p-6 rounded-xl w-full max-w-2xl">

            <h2 class="text-xl font-bold mb-4">Chi tiết phiếu xuất</h2>

            <div id="modalInfo" class="text-sm mb-3"></div>

            <table class="w-full text-sm border">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="px-3 py-2">Sản phẩm</th>
                        <th class="px-3 py-2">SL</th>
                        <th class="px-3 py-2">Giá</th>
                        <th class="px-3 py-2 text-right">Tổng</th>
                    </tr>
                </thead>
                <tbody id="modalTable"></tbody>
            </table>

            <div class="mt-4 flex justify-between font-semibold">
                <span>Tổng tiền:</span>
                <span id="modalTotal"></span>
            </div>

            <div class="mt-4 text-right">
                <button onclick="closeModal()" class="px-4 py-2 bg-primary text-white rounded-lg">
                    Đóng
                </button>
            </div>
        </div>
    </div>

</div>

</div>
</div>
</main>
</div>

<script>
const API_PRODUCTS = "http://127.0.0.1:8000/products/";
const API_EXPORT = "http://127.0.0.1:8000/export/"; // nếu file backend là export.py

let allProducts = [];
let detailList = [];

/* ========== LOAD SẢN PHẨM ========== */
async function loadProducts() {
    const res = await fetch(API_PRODUCTS);
    allProducts = await res.json();

    const select = document.getElementById("select_product");
    select.innerHTML = `<option value="">-- Chọn sản phẩm --</option>`;

    allProducts.forEach(p => {
        select.innerHTML += `<option value="${p.id}">${p.name} (${p.sku}) - Tồn: ${p.stock}</option>`;
    });
}

/* ========== THÊM SẢN PHẨM ========== */
function addProductToTable() {
    const id = document.getElementById("select_product").value;
    const qty = Number(document.getElementById("select_quantity").value);

    if (!id || qty <= 0) return alert("Vui lòng chọn sản phẩm và nhập số lượng!");

    const product = allProducts.find(p => p.id == id);
    if (!product) return alert("Sản phẩm không tồn tại!");

    if (qty > product.stock) {
        return alert(`Sản phẩm ${product.name} chỉ còn ${product.stock} trong kho!`);
    }

    const price = product.sell_price || product.import_price || 0;
    const total = qty * price;

    detailList.push({
        product_id: product.id,
        name: product.name,
        quantity: qty,
        unit: product.unit,
        price: price,
        total_price: total
    });

    renderTable();
}

/* ========== RENDER BẢNG CHI TIẾT ========== */
function renderTable() {
    const tbody = document.getElementById("detailTable");
    tbody.innerHTML = "";

    detailList.forEach((d, i) => {
        tbody.innerHTML += `
            <tr class="border-b">
                <td class="px-4 py-3">${d.name}</td>
                <td class="px-4 py-3">${d.unit}</td>
                <td class="px-4 py-3">${d.quantity}</td>
                <td class="px-4 py-3">${d.price.toLocaleString()} đ</td>
                <td class="px-4 py-3 text-right">${d.total_price.toLocaleString()} đ</td>
                <td><button onclick="removeDetail(${i})" class="text-red-500">X</button></td>
            </tr>
        `;
    });

    calcTotal();
}

/* ========== XÓA SẢN PHẨM ========== */
function removeDetail(i) {
    detailList.splice(i, 1);
    renderTable();
}

/* ========== TÍNH TỔNG ========== */
function calcTotal() {
    const total = detailList.reduce((sum, d) => sum + d.total_price, 0);
    document.getElementById("total_price").innerText = total.toLocaleString() + " đ";
    document.getElementById("final_price").innerText = total.toLocaleString() + " đ";
}

/* ========== GỬI PHIẾU XUẤT ========== */
async function submitExport() {
    const code = document.getElementById("export_code").value;
    const receiver = document.getElementById("receiver").value;
    const date = document.getElementById("export_date").value;

    if (!code || !receiver || !date) {
        return alert("Vui lòng nhập đầy đủ thông tin!");
    }

    if (detailList.length === 0) {
        return alert("Vui lòng thêm sản phẩm!");
    }

    const payload = {
        code: code,
        customer: receiver,  // backend dùng key 'customer'
        export_date: date,
        details: detailList.map(d => ({
            product_id: d.product_id,
            quantity: d.quantity,
            price: d.price
        }))
    };

    try {
        const res = await fetch(API_EXPORT, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });

        if (!res.ok) {
            const err = await res.json();
            return alert("Lỗi xuất kho: " + (err.detail || JSON.stringify(err)));
        }

        alert("Xuất kho thành công!");
        detailList = [];
        renderTable();
        loadHistory();
    } catch (error) {
        console.error(error);
        alert("Lỗi kết nối tới server!");
    }
}

/* ========== LOAD LỊCH SỬ XUẤT KHO ========== */
async function loadHistory() {
    try {
        const res = await fetch(API_EXPORT);
        const data = await res.json();
        data.sort((a, b) => b.id - a.id);

        const box = document.getElementById("historyBox");
        box.innerHTML = "";

        data.forEach(item => {
            box.innerHTML += `
                <div onclick="openDetail(${item.id})"
                     class="p-4 border rounded-lg cursor-pointer hover:bg-gray-100">
                    <div class="font-semibold">${item.code}</div>
                    <div class="text-sm text-gray-600">Người nhận: ${item.receiver}</div>
                    <div class="text-sm">Ngày: ${item.export_date}</div>
                    <div class="text-sm font-semibold text-primary mt-1">
                        Tổng: ${(item.total || 0).toLocaleString()} đ
                    </div>
                </div>
            `;
        });
    } catch (error) {
        console.error(error);
    }
}

/* ========== XEM CHI TIẾT PHIẾU ========== */
async function openDetail(id) {
    try {
        const res = await fetch(API_EXPORT + id);
        const json = await res.json();

        document.getElementById("exportDetailModal").classList.remove("hidden");

        const info = json.export;

        document.getElementById("modalInfo").innerHTML = `
            <div><b>Mã phiếu:</b> ${info.code}</div>
            <div><b>Người nhận:</b> ${info.customer}</div>
            <div><b>Ngày xuất:</b> ${info.export_date}</div>
        `;

        const tbody = document.getElementById("modalTable");
        tbody.innerHTML = "";

        json.details.forEach(d => {
            tbody.innerHTML += `
                <tr class="border-b">
                    <td class="px-3 py-2">${d.product_name}</td>
                    <td class="px-3 py-2">${d.quantity}</td>
                    <td class="px-3 py-2">${d.price.toLocaleString()} đ</td>
                    <td class="px-3 py-2 text-right">${d.total_price.toLocaleString()} đ</td>
                </tr>
            `;
        });

        document.getElementById("modalTotal").innerText =
            (json.export.total || 0).toLocaleString() + " đ";
    } catch (error) {
        console.error(error);
    }
}

function closeModal() {
    document.getElementById("exportDetailModal").classList.add("hidden");
}

// ================= INIT =================
loadProducts();
loadHistory();
</script>


</body>
</html>
